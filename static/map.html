<!DOCTYPE html>
<html>
  <head>
    <title>Warsaw U-AQI Monitor</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
      body { margin: 0; padding: 0; font-family: sans-serif; }
      #map { height: 100vh; width: 100%; }
      .legend {
          position: absolute;
          top: 10px;
          right: 10px;
          z-index: 1000;
          background: white;
          padding: 15px;
          border-radius: 8px;
          box-shadow: 0 0 10px rgba(0,0,0,0.2);
          font-size: 14px;
      }
      .dot { height: 12px; width: 12px; display: inline-block; border-radius: 50%; margin-right: 8px; vertical-align: middle;}
      .status-bar {
          position: absolute;
          bottom: 10px;
          left: 10px;
          z-index: 1000;
          background: rgba(255, 255, 255, 0.9);
          padding: 5px 10px;
          border-radius: 4px;
          font-size: 12px;
      }
    </style>
  </head>
  <body>

    <div class="legend">
        <h3>U-AQI Index</h3>
        <div><span class="dot" style="background:#00cc00;"></span>0-50: Good</div>
        <div><span class="dot" style="background:#ffff00;"></span>51-100: Moderate</div>
        <div><span class="dot" style="background:#ff9900;"></span>101-150: Sensitive</div>
        <div><span class="dot" style="background:#ff0000;"></span>151-200: Unhealthy</div>
        <div><span class="dot" style="background:#800080;"></span>> 200: Hazardous</div>
    </div>

    <div id="status" class="status-bar">Initializing...</div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
      var map;
      // Changed from array to object for faster lookups by name
      var markers = {};

      // --- COLOR SCALE (Based on PDF Section 5) ---
      function getAqiColor(aqi) {
          if (aqi > 200) return '#800080'; // Purple/Maroon (Hazardous)
          if (aqi > 150) return '#ff0000'; // Red (Unhealthy)
          if (aqi > 100) return '#ff9900'; // Orange (Sensitive)
          if (aqi > 50)  return '#ffff00'; // Yellow (Moderate)
          return '#00cc00';                // Green (Good)
      }

      // --- MOCK DATA (For Preview Mode) ---
      function generateMockData() {
          const mockSensors = [];
          const centerLat = 52.2297;
          const centerLng = 21.0122;

          for (let i = 0; i < 50; i++) {
              // Simulate calculated AQI directly
              const mockAqi = Math.floor(Math.random() * 250);

              mockSensors.push({
                  name: `sim_sensor_${i}`,
                  lat: centerLat + (Math.random() - 0.5) * 0.15,
                  lng: centerLng + (Math.random() - 0.5) * 0.25,
                  aqi: mockAqi,
                  details: {
                      pm1_0: (mockAqi * 0.2).toFixed(2),
                      pm2_5: (mockAqi * 0.4).toFixed(2),
                      pm10: (mockAqi * 0.6).toFixed(2),
                      temperature: 15 + Math.random() * 10,
                      humidity: 40 + Math.random() * 20,
                      carbon_dioxide: 400 + Math.random() * 100,
                      voc_index: mockAqi,
                      nox_index: mockAqi * 0.8
                  }
              });
          }
          return mockSensors;
      }

      function initMap() {
        map = L.map('map').setView([52.2297, 21.0122], 12);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        fetchData();
        setInterval(fetchData, 2000);
      }

      async function fetchData() {
        const statusDiv = document.getElementById('status');
        let sensors = [];

        try {
            if (window.location.protocol === 'blob:' || window.location.href.includes('googleusercontent')) {
                 statusDiv.innerText = "Mode: Preview (Mock Data)";
                 sensors = generateMockData();
            } else {
                 statusDiv.innerText = "Mode: Live Connection";
                 const response = await fetch('/api/pollution-data');
                 if (!response.ok) throw new Error("Network response was not ok");
                 sensors = await response.json();
            }

            // Track which sensors are present in this update
            const currentSensorNames = new Set();

            sensors.forEach(sensor => {
                currentSensorNames.add(sensor.name);
                const color = getAqiColor(sensor.aqi);

                // Prepare content string
                const popupContent = `
                    <div style="min-width: 160px; font-family: sans-serif;">
                        <h3 style="margin:0; border-bottom: 2px solid ${color}; padding-bottom: 5px;">${sensor.name}</h3>
                        <div style="font-size: 1.2em; font-weight:bold; margin: 10px 0;">
                            AQI: ${sensor.aqi}
                        </div>

                        <div style="background-color: #f5f5f5; padding: 5px; border-radius: 4px; margin-bottom: 5px;">
                            <strong>Environment</strong><br>
                            Temp: ${Number(sensor.details.temperature).toFixed(1)} °C<br>
                            Humidity: ${Number(sensor.details.humidity).toFixed(1)} %<br>
                            CO2: ${Number(sensor.details.carbon_dioxide).toFixed(0)} ppm
                        </div>

                        <div style="background-color: #f5f5f5; padding: 5px; border-radius: 4px; margin-bottom: 5px;">
                            <strong>Particulate Matter</strong><br>
                            PM 1.0: ${sensor.details.pm1_0} µg/m³<br>
                            PM 2.5: ${sensor.details.pm2_5} µg/m³<br>
                            PM 10: ${sensor.details.pm10} µg/m³
                        </div>

                        <div style="background-color: #f5f5f5; padding: 5px; border-radius: 4px;">
                            <strong>Gas Indices</strong><br>
                            VOC: ${Number(sensor.details.voc_index).toFixed(0)}<br>
                            NOx: ${Number(sensor.details.nox_index).toFixed(0)}
                        </div>
                    </div>
                `;

                if (markers[sensor.name]) {
                    // UPDATE existing marker
                    markers[sensor.name].setStyle({ fillColor: color });
                    markers[sensor.name].setPopupContent(popupContent);
                } else {
                    // CREATE new marker
                    var circle = L.circleMarker([sensor.lat, sensor.lng], {
                        color: '#333',
                        weight: 1,
                        fillColor: color,
                        fillOpacity: 0.8,
                        radius: 12
                    }).addTo(map);

                    circle.bindPopup(popupContent);
                    markers[sensor.name] = circle;
                }
            });

            // Cleanup: Remove markers that are no longer in the data
            for (let name in markers) {
                if (!currentSensorNames.has(name)) {
                    map.removeLayer(markers[name]);
                    delete markers[name];
                }
            }

        } catch (error) {
            console.error("Error fetching data:", error);
            statusDiv.innerText = "Error: " + error.message;
            // Fallback to mock data if fetch fails
            if (Object.keys(markers).length === 0) {
                 // Trigger one mock update so screen isn't empty on error
                 // (Simplified logic here to avoid infinite recursion)
            }
        }
      }

      initMap();
    </script>
  </body>
</html>
