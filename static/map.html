<!DOCTYPE html>
<html>
  <head>
    <title>Warsaw U-AQI Monitor</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
      body { margin: 0; padding: 0; font-family: sans-serif; }
      #map { height: 100vh; width: 100%; }
      .legend {
          position: absolute;
          top: 10px;
          right: 10px;
          z-index: 1000;
          background: white;
          padding: 15px;
          border-radius: 8px;
          box-shadow: 0 0 10px rgba(0,0,0,0.2);
          font-size: 14px;
      }
      .dot { height: 12px; width: 12px; display: inline-block; border-radius: 50%; margin-right: 8px; vertical-align: middle;}
      .status-bar {
          position: absolute;
          bottom: 10px;
          left: 10px;
          z-index: 1000;
          background: rgba(255, 255, 255, 0.9);
          padding: 5px 10px;
          border-radius: 4px;
          font-size: 12px;
      }
    </style>
  </head>
  <body>

    <div class="legend">
        <h3>U-AQI Index</h3>
        <div><span class="dot" style="background:#00cc00;"></span>0-50: Good</div>
        <div><span class="dot" style="background:#ffff00;"></span>51-100: Moderate</div>
        <div><span class="dot" style="background:#ff9900;"></span>101-150: Sensitive</div>
        <div><span class="dot" style="background:#ff0000;"></span>151-200: Unhealthy</div>
        <div><span class="dot" style="background:#800080;"></span>> 200: Hazardous</div>
    </div>

    <div id="status" class="status-bar">Initializing...</div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
      // ================= CONFIGURATION =================
      // STEP 1: Deploy your backend (main.py) to a cloud provider (Render/Railway).
      // STEP 2: Paste the URL they give you below.
      // Example: const BACKEND_URL = "https://my-app.onrender.com";

      const BACKEND_URL = "";

      // NOTE: If BACKEND_URL is empty, it tries to use the local relative path (good for localhost)
      // =================================================

      var map;
      var markers = [];

      function getAqiColor(aqi) {
          if (aqi > 200) return '#800080';
          if (aqi > 150) return '#ff0000';
          if (aqi > 100) return '#ff9900';
          if (aqi > 50)  return '#ffff00';
          return '#00cc00';
      }

      function generateMockData() {
          const mockSensors = [];
          const centerLat = 52.2297;
          const centerLng = 21.0122;

          for (let i = 0; i < 50; i++) {
              const mockAqi = Math.floor(Math.random() * 250);
              mockSensors.push({
                  name: `sim_sensor_${i}`,
                  lat: centerLat + (Math.random() - 0.5) * 0.15,
                  lng: centerLng + (Math.random() - 0.5) * 0.25,
                  aqi: mockAqi,
                  details: {
                      pm2_5: mockAqi * 0.4,
                      pm10: mockAqi * 0.6,
                      temperature: 15,
                      voc_index: mockAqi,
                      nox_index: mockAqi * 0.8
                  }
              });
          }
          return mockSensors;
      }

      function initMap() {
        map = L.map('map').setView([52.2297, 21.0122], 12);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        fetchData();
        setInterval(fetchData, 2000);
      }

      async function fetchData() {
        const statusDiv = document.getElementById('status');
        let sensors = [];

        try {
            // Determine API URL
            let apiUrl = '/api/pollution-data'; // Default (localhost)
            if (BACKEND_URL && BACKEND_URL.trim() !== "") {
                // Ensure no trailing slash
                const baseUrl = BACKEND_URL.replace(/\/$/, "");
                apiUrl = `${baseUrl}/api/pollution-data`;
            }

            if (window.location.protocol === 'blob:' || window.location.href.includes('googleusercontent')) {
                 statusDiv.innerText = "Mode: Preview (Mock Data)";
                 sensors = generateMockData();
            } else {
                 statusDiv.innerText = "Mode: Live Connection (" + (BACKEND_URL ? "Cloud" : "Local") + ")";
                 const response = await fetch(apiUrl);
                 if (!response.ok) throw new Error("Network response was not ok");
                 sensors = await response.json();
            }

            markers.forEach(m => map.removeLayer(m));
            markers = [];

            sensors.forEach(sensor => {
                const color = getAqiColor(sensor.aqi);

                var circle = L.circleMarker([sensor.lat, sensor.lng], {
                    color: '#333',
                    weight: 1,
                    fillColor: color,
                    fillOpacity: 0.8,
                    radius: 12
                }).addTo(map);

                circle.bindPopup(`
                    <div style="min-width: 150px; font-family: sans-serif;">
                        <h3 style="margin:0;">${sensor.name}</h3>
                        <div style="font-size: 1.2em; font-weight:bold; margin: 5px 0;">
                            AQI: ${sensor.aqi}
                        </div>
                        <hr style="margin: 5px 0; border: 0; border-top: 1px solid #ccc;">
                        <small>
                        <b>PM 2.5:</b> ${sensor.details.pm2_5} µg/m³<br>
                        <b>PM 10:</b> ${sensor.details.pm10} µg/m³<br>
                        <b>VOC Idx:</b> ${sensor.details.voc_index.toFixed(0)}<br>
                        <b>NOx Idx:</b> ${sensor.details.nox_index.toFixed(0)}
                        </small>
                    </div>
                `);

                markers.push(circle);
            });

        } catch (error) {
            console.error("Error fetching data:", error);
            statusDiv.innerText = "Error: " + error.message;
            if (markers.length === 0) sensors = generateMockData();
        }
      }

      initMap();
    </script>
  </body>
</html>
