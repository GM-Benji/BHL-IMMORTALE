<!DOCTYPE html>
<html>
  <head>
    <title>Warsaw U-AQI Monitor</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body { margin: 0; padding: 0; font-family: sans-serif; }
      #map { height: 100vh; width: 100%; }

      .legend {
          position: absolute;
          top: 10px;
          right: 10px;
          z-index: 1000;
          background: white;
          padding: 15px;
          border-radius: 8px;
          box-shadow: 0 0 10px rgba(0,0,0,0.2);
          font-size: 14px;
          min-width: 150px;
      }

      .dot { height: 12px; width: 12px; display: inline-block; border-radius: 50%; margin-right: 8px; vertical-align: middle;}

      .status-bar {
          position: absolute;
          bottom: 10px;
          left: 10px;
          z-index: 1000;
          background: rgba(255, 255, 255, 0.9);
          padding: 5px 10px;
          border-radius: 4px;
          font-size: 12px;
      }

      /* TOGGLE BUTTON STYLE */
      .mode-toggle {
          position: absolute;
          top: 20px;
          left: 60px; /* Offset from zoom controls */
          z-index: 1000;
          background: white;
          border: 2px solid #ccc;
          border-radius: 4px;
          cursor: pointer;
          overflow: hidden;
          box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      }

      .mode-btn {
          padding: 10px 20px;
          font-weight: bold;
          font-size: 14px;
          background: white;
          border: none;
          cursor: pointer;
          transition: background 0.3s;
      }

      .mode-btn:hover {
          background: #f0f0f0;
      }

      .mode-btn.active {
          background: #007bff;
          color: white;
      }

      /* POPUP CHART STYLES */
      .popup-container {
          display: flex;
          flex-direction: row;
          width: 500px;
          font-family: sans-serif;
      }
      .popup-stats {
          flex: 1;
          padding-right: 15px;
          border-right: 1px solid #ddd;
      }
      .popup-chart-wrapper {
          flex: 1.2;
          padding-left: 15px;
          display: flex;
          align-items: center;
          justify-content: center;
          min-height: 200px;
      }
    </style>
  </head>
  <body>

    <!-- CONTROL BUTTON -->
    <div class="mode-toggle">
        <button id="btn-aqi" class="mode-btn active" onclick="setMode('aqi')">Air Quality</button>
        <button id="btn-soil" class="mode-btn" onclick="setMode('soil')">Soil Humidity</button>
    </div>

    <!-- LEGEND (Dynamic Content) -->
    <div id="legend" class="legend">
        <!-- Content injected by JS -->
    </div>

    <div id="status" class="status-bar">Initializing...</div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
      var map;
      var markers = {};
      var currentMode = 'aqi'; // 'aqi' or 'soil'
      var lastSensorData = [];

      // Chart Globals
      var activeSensorName = null;
      var activeChart = null;

      // --- COLOR SCALES ---

      function getAqiColor(aqi) {
          if (aqi > 200) return '#800080'; // Purple
          if (aqi > 150) return '#ff0000'; // Red
          if (aqi > 100) return '#ff9900'; // Orange
          if (aqi > 50)  return '#ffff00'; // Yellow
          return '#00cc00';                // Green
      }

      function getSoilColor(humidity) {
          if (humidity < 20) return '#d2691e'; // Chocolate
          if (humidity < 40) return '#f4a460'; // Sandy Brown
          if (humidity < 60) return '#9acd32'; // YellowGreen
          if (humidity < 80) return '#32cd32'; // LimeGreen
          return '#0000cd';                // MediumBlue
      }

      // --- LEGEND RENDERER ---
      function updateLegend() {
          const legendDiv = document.getElementById('legend');
          if (currentMode === 'aqi') {
              legendDiv.innerHTML = `
                <h3>U-AQI Index</h3>
                <div><span class="dot" style="background:#00cc00;"></span>0-50: Good</div>
                <div><span class="dot" style="background:#ffff00;"></span>51-100: Moderate</div>
                <div><span class="dot" style="background:#ff9900;"></span>101-150: Sensitive</div>
                <div><span class="dot" style="background:#ff0000;"></span>151-200: Unhealthy</div>
                <div><span class="dot" style="background:#800080;"></span>> 200: Hazardous</div>
              `;
          } else {
              legendDiv.innerHTML = `
                <h3>Soil Humidity</h3>
                <div><span class="dot" style="background:#d2691e;"></span>0-20%: Very Dry</div>
                <div><span class="dot" style="background:#f4a460;"></span>21-40%: Dry</div>
                <div><span class="dot" style="background:#9acd32;"></span>41-60%: Moderate</div>
                <div><span class="dot" style="background:#32cd32;"></span>61-80%: Moist</div>
                <div><span class="dot" style="background:#0000cd;"></span>81-100%: Wet</div>
              `;
          }
      }

      // --- MODE SWITCHER ---
      function setMode(mode) {
          currentMode = mode;

          document.getElementById('btn-aqi').className = mode === 'aqi' ? 'mode-btn active' : 'mode-btn';
          document.getElementById('btn-soil').className = mode === 'soil' ? 'mode-btn active' : 'mode-btn';

          updateLegend();
          renderMarkers(lastSensorData);

          // If a popup is open, we need to refresh the chart to show the new metric
          if (activeSensorName && activeChart) {
              fetchHistoryAndDrawChart(activeSensorName);
          }
      }

      // --- CHART LOGIC ---

      async function fetchHistoryAndDrawChart(sensorName) {
          try {
              let historyData = [];
              // In Mock Mode, generate fake history
              if (window.location.protocol === 'blob:' || window.location.href.includes('googleusercontent')) {
                   historyData = Array.from({length: 20}, (_, i) => ({
                       timestamp: Date.now() / 1000 - (20 - i) * 5,
                       pm2_5: Math.random() * 50,
                       pm10: Math.random() * 80,
                       soil_humidity: Math.random() * 100
                   }));
              } else {
                   const res = await fetch(`/api/history/${sensorName}`);
                   if (res.ok) historyData = await res.json();
              }

              const ctx = document.getElementById('popup-chart');
              if (!ctx) return; // Popup might have closed

              // Destroy previous chart if exists
              if (activeChart) {
                  activeChart.destroy();
              }

              const labels = historyData.map(d => {
                  const date = new Date(d.timestamp * 1000);
                  return date.getHours() + ':' + date.getMinutes().toString().padStart(2, '0') + ':' + date.getSeconds().toString().padStart(2, '0');
              });

              let datasets = [];
              if (currentMode === 'aqi') {
                  datasets = [
                      {
                          label: 'PM 2.5',
                          data: historyData.map(d => d.pm2_5),
                          borderColor: 'rgb(255, 99, 132)',
                          tension: 0.3,
                          fill: false
                      },
                      {
                          label: 'PM 10',
                          data: historyData.map(d => d.pm10),
                          borderColor: 'rgb(54, 162, 235)',
                          tension: 0.3,
                          fill: false
                      }
                  ];
              } else {
                  datasets = [
                      {
                          label: 'Soil Humidity (%)',
                          data: historyData.map(d => d.soil_humidity),
                          borderColor: 'rgb(75, 192, 192)',
                          backgroundColor: 'rgba(75, 192, 192, 0.2)',
                          tension: 0.3,
                          fill: true
                      }
                  ];
              }

              activeChart = new Chart(ctx, {
                  type: 'line',
                  data: { labels: labels, datasets: datasets },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      animation: false, // Disable animation for smoother live updates
                      plugins: {
                          legend: { position: 'top', labels: { boxWidth: 10 } }
                      },
                      scales: {
                          x: { display: false }, // Hide timestamps to save space
                          y: { beginAtZero: true }
                      }
                  }
              });

          } catch (e) {
              console.error("Error drawing chart", e);
          }
      }

      function initMap() {
        map = L.map('map').setView([52.2297, 21.0122], 12);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        // --- EVENT LISTENERS FOR POPUP ---
        map.on('popupopen', function(e) {
             const marker = e.popup._source;
             // We need to find the sensor name.
             // We stored markers keyed by name, but here we have the marker object.
             // Let's iterate markers to find the name (inefficient but safe) or attach name to marker options.
             // Better: Attach name to the marker object directly during creation.
             if (marker.sensorName) {
                 activeSensorName = marker.sensorName;
                 // Slight delay to ensure DOM is ready
                 setTimeout(() => fetchHistoryAndDrawChart(activeSensorName), 50);
             }
        });

        map.on('popupclose', function() {
            if (activeChart) {
                activeChart.destroy();
                activeChart = null;
            }
            activeSensorName = null;
        });

        updateLegend();
        fetchData();
        setInterval(fetchData, 2000);
      }

      // --- MOCK DATA GENERATOR ---
      function generateMockData() {
          const mockSensors = [];
          const centerLat = 52.2297;
          const centerLng = 21.0122;
          for (let i = 0; i < 50; i++) {
              const mockAqi = Math.floor(Math.random() * 250);
              const mockSoil = Math.random() * 100;
              mockSensors.push({
                  name: `sim_sensor_${i}`,
                  lat: centerLat + (Math.random() - 0.5) * 0.15,
                  lng: centerLng + (Math.random() - 0.5) * 0.25,
                  aqi: mockAqi,
                  details: {
                      soil_humidity: mockSoil.toFixed(1),
                      pm1_0: (mockAqi * 0.2).toFixed(2),
                      pm2_5: (mockAqi * 0.4).toFixed(2),
                      pm10: (mockAqi * 0.6).toFixed(2),
                      temperature: 15 + Math.random() * 10,
                      humidity: 40 + Math.random() * 20,
                      carbon_dioxide: 400 + Math.random() * 100,
                      voc_index: mockAqi,
                      nox_index: mockAqi * 0.8
                  }
              });
          }
          return mockSensors;
      }

      function renderMarkers(sensors) {
          const currentSensorNames = new Set();

          sensors.forEach(sensor => {
                currentSensorNames.add(sensor.name);

                let color;
                if (currentMode === 'aqi') {
                    color = getAqiColor(sensor.aqi);
                } else {
                    color = getSoilColor(parseFloat(sensor.details.soil_humidity));
                }

                // If this sensor is currently OPEN, we update stats DOM and Chart directly
                if (activeSensorName === sensor.name) {
                    // Update Text Values safely
                    const elAqi = document.getElementById('popup-val-aqi');
                    if (elAqi) elAqi.innerText = sensor.aqi;

                    const elSoil = document.getElementById('popup-val-soil');
                    if (elSoil) elSoil.innerText = Number(sensor.details.soil_humidity).toFixed(1);

                    const elPm25 = document.getElementById('popup-val-pm25');
                    if (elPm25) elPm25.innerText = sensor.details.pm2_5;

                    // Update Chart Live
                    if (activeChart) {
                        const newLabel = new Date().toLocaleTimeString();
                        activeChart.data.labels.push(newLabel);
                        if (activeChart.data.labels.length > 20) activeChart.data.labels.shift();

                        if (currentMode === 'aqi') {
                            // PM 2.5
                            activeChart.data.datasets[0].data.push(sensor.details.pm2_5);
                            if (activeChart.data.datasets[0].data.length > 20) activeChart.data.datasets[0].data.shift();
                            // PM 10
                            activeChart.data.datasets[1].data.push(sensor.details.pm10);
                            if (activeChart.data.datasets[1].data.length > 20) activeChart.data.datasets[1].data.shift();
                        } else {
                            // Soil
                            activeChart.data.datasets[0].data.push(sensor.details.soil_humidity);
                            if (activeChart.data.datasets[0].data.length > 20) activeChart.data.datasets[0].data.shift();
                        }
                        activeChart.update('none'); // Update without animation
                    }

                    // Update the marker color too
                    if (markers[sensor.name]) {
                        markers[sensor.name].setStyle({ fillColor: color });
                    }

                } else {
                    // Normal render for closed popups
                    const popupContent = `
                        <div class="popup-container">
                            <div class="popup-stats">
                                <h3 style="margin:0; border-bottom: 2px solid ${color}; padding-bottom: 5px;">${sensor.name}</h3>

                                <div style="font-size: 1.1em; font-weight:bold; margin: 10px 0; color: #333;">
                                    AQI: <span id="popup-val-aqi">${sensor.aqi}</span> |
                                    Soil: <span id="popup-val-soil">${Number(sensor.details.soil_humidity).toFixed(1)}</span>%
                                </div>

                                <div style="background-color: #f5f5f5; padding: 5px; border-radius: 4px; margin-bottom: 5px;">
                                    <strong>PM 2.5:</strong> <span id="popup-val-pm25">${sensor.details.pm2_5}</span> µg/m³<br>
                                    <strong>Temp:</strong> ${Number(sensor.details.temperature).toFixed(1)} °C<br>
                                    <strong>Air Hum:</strong> ${Number(sensor.details.humidity).toFixed(1)} %
                                </div>
                            </div>
                            <div class="popup-chart-wrapper">
                                <canvas id="popup-chart"></canvas>
                            </div>
                        </div>
                    `;

                    if (markers[sensor.name]) {
                        markers[sensor.name].setStyle({ fillColor: color });
                        markers[sensor.name].setPopupContent(popupContent);
                    } else {
                        var circle = L.circleMarker([sensor.lat, sensor.lng], {
                            color: '#333',
                            weight: 1,
                            fillColor: color,
                            fillOpacity: 0.8,
                            radius: 12
                        }).addTo(map);

                        // Attach ID to marker for event listener
                        circle.sensorName = sensor.name;

                        // Important: Increase maxWidth for the chart
                        circle.bindPopup(popupContent, { maxWidth: 550 });
                        markers[sensor.name] = circle;
                    }
                }
            });

            for (let name in markers) {
                if (!currentSensorNames.has(name)) {
                    map.removeLayer(markers[name]);
                    delete markers[name];
                }
            }
      }

      async function fetchData() {
        const statusDiv = document.getElementById('status');
        let sensors = [];

        try {
            if (window.location.protocol === 'blob:' || window.location.href.includes('googleusercontent')) {
                 statusDiv.innerText = "Mode: Preview (Mock Data)";
                 sensors = generateMockData();
            } else {
                 statusDiv.innerText = "Mode: Live Connection";
                 const response = await fetch('/api/pollution-data');
                 if (!response.ok) throw new Error("Network response was not ok");
                 sensors = await response.json();
            }

            lastSensorData = sensors;
            renderMarkers(sensors);

        } catch (error) {
            console.error("Error fetching data:", error);
            statusDiv.innerText = "Error: " + error.message;
        }
      }

      initMap();
    </script>
  </body>
</html>
